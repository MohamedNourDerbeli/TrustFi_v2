# Requirements Document

## Introduction

This specification defines the core user journey for TrustFi, a cross-chain composable reputation system. The system enables users to create soulbound Profile NFTs, claim or receive Reputation Cards from issuers, and calculate their reputation scores. Additionally, it defines the admin portal functionality that allows administrators to manage issuers, create templates, and issue reputation cards to users.

The core flow encompasses: visitor authentication via wallet connection, profile creation, reputation card claiming (both direct issuance and signature-based claiming), score calculation, and profile viewing. The admin portal provides template management, direct card issuance, and issuer role management capabilities.

## Glossary

- **TrustFi_System**: The complete web application including smart contracts, frontend, and backend services
- **ProfileNFT**: A soulbound (non-transferable) ERC721 token representing a user's identity, limited to one per wallet address
- **ReputationCard**: A soulbound ERC721 token representing an achievement or credential, attached to a ProfileNFT
- **Template**: A configuration defining the properties of a ReputationCard type (issuer, tier, supply limits, time windows)
- **Tier**: A numeric level (1-3) assigned to a template that determines the score contribution of cards minted from that template
- **Score**: A numeric value calculated by summing the tier values of all ReputationCards attached to a ProfileNFT
- **Issuer**: An address with permission to create templates and issue ReputationCards to users
- **Admin**: An address with DEFAULT_ADMIN_ROLE capable of managing issuers and system configuration
- **Claim_Signature**: A cryptographic signature generated by an issuer allowing a specific user to claim a ReputationCard
- **Supabase_Database**: The off-chain database storing user profiles, wallet mappings, and metadata
- **Wallet_Connection**: The process of authenticating a user by connecting their Web3 wallet via wagmi

## Requirements

### Requirement 1: Wallet Connection and Authentication

**User Story:** As a visitor, I want to connect my Web3 wallet to the TrustFi application, so that I can authenticate and access my profile or create a new one.

#### Acceptance Criteria

1. WHEN a visitor navigates to the TrustFi application, THE TrustFi_System SHALL display a wallet connection interface
2. WHEN a visitor clicks the wallet connection button, THE TrustFi_System SHALL initiate the Wallet_Connection process using wagmi
3. WHEN the Wallet_Connection process completes successfully, THE TrustFi_System SHALL retrieve the connected wallet address
4. WHEN a wallet address is retrieved, THE TrustFi_System SHALL query the Supabase_Database to check if a profile exists for that address
5. WHEN no profile exists in the Supabase_Database for the connected wallet, THE TrustFi_System SHALL display the profile creation interface

### Requirement 2: Profile Creation

**User Story:** As an authenticated user without a profile, I want to create my ProfileNFT, so that I can start building my reputation and receiving ReputationCards.

#### Acceptance Criteria

1. WHEN a user without a profile provides a token URI and clicks create profile, THE TrustFi_System SHALL call the createProfile function on the ProfileNFT smart contract
2. WHEN the createProfile transaction is confirmed on-chain, THE TrustFi_System SHALL retrieve the newly minted ProfileNFT token ID
3. WHEN the ProfileNFT token ID is retrieved, THE TrustFi_System SHALL store the wallet address, profile ID, and token URI in the Supabase_Database
4. WHEN the profile data is stored successfully, THE TrustFi_System SHALL display a success message to the user
5. IF a user attempts to create a second profile with the same wallet address, THEN THE TrustFi_System SHALL reject the transaction with an error message indicating that a profile already exists

### Requirement 3: Profile Viewing and Score Display

**User Story:** As an authenticated user with a profile, I want to view my ProfileNFT details and current reputation score, so that I can track my achievements and reputation status.

#### Acceptance Criteria

1. WHEN a user with a profile navigates to their profile page, THE TrustFi_System SHALL retrieve the user's ProfileNFT token ID from the smart contract
2. WHEN the ProfileNFT token ID is retrieved, THE TrustFi_System SHALL query the profileIdToScore mapping to retrieve the current reputation score
3. WHEN the reputation score is retrieved, THE TrustFi_System SHALL display the score value on the profile page
4. WHEN the profile page loads, THE TrustFi_System SHALL retrieve all ReputationCard token IDs attached to the ProfileNFT by calling getCardsForProfile
5. WHEN the ReputationCard token IDs are retrieved, THE TrustFi_System SHALL display each card with its metadata including tier and issuer information

### Requirement 4: Score Recalculation

**User Story:** As an authenticated user with a profile, I want to manually recalculate my reputation score, so that my score reflects any newly claimed ReputationCards.

#### Acceptance Criteria

1. WHEN a user clicks the recalculate score button, THE TrustFi_System SHALL call the recalculateMyScore function on the ProfileNFT smart contract
2. WHEN the recalculateMyScore function executes, THE TrustFi_System SHALL trigger the calculateScoreForProfile function on the ReputationCard contract
3. WHEN the calculateScoreForProfile function completes, THE TrustFi_System SHALL sum the tier scores of all attached ReputationCards
4. WHEN the new score is calculated, THE TrustFi_System SHALL update the profileIdToScore mapping with the new value
5. WHEN the score update transaction is confirmed, THE TrustFi_System SHALL display the updated score to the user

### Requirement 5: Template Discovery

**User Story:** As an authenticated user with a profile, I want to discover available ReputationCard templates, so that I can identify which credentials I am eligible to claim.

#### Acceptance Criteria

1. WHEN a user navigates to the discover collectibles page, THE TrustFi_System SHALL retrieve all active Template records from the smart contract
2. WHEN Template records are retrieved, THE TrustFi_System SHALL display each template with its name, description, tier, and issuer information
3. WHEN displaying each template, THE TrustFi_System SHALL check if the template is paused by reading the isPaused property
4. IF a template isPaused property is true, THEN THE TrustFi_System SHALL display the template as unavailable for claiming
5. WHEN displaying each template, THE TrustFi_System SHALL check if the user's profile has already claimed a card from that template by reading hasProfileClaimed mapping

### Requirement 6: Direct Card Issuance by Issuer

**User Story:** As an issuer, I want to directly issue a ReputationCard to a specific user's profile, so that I can reward users for achievements without requiring them to claim manually.

#### Acceptance Criteria

1. WHEN an issuer provides a recipient address, template ID, and token URI, THE TrustFi_System SHALL verify that the caller address matches the template issuer address
2. WHEN the issuer verification succeeds, THE TrustFi_System SHALL verify that the recipient address has a ProfileNFT by checking addressToProfileId mapping
3. WHEN the ProfileNFT exists, THE TrustFi_System SHALL verify that the profile has not already claimed a card from the specified template
4. WHEN all verifications pass, THE TrustFi_System SHALL mint a new ReputationCard token and transfer it to the ProfileNFT contract
5. WHEN the ReputationCard is minted, THE TrustFi_System SHALL call notifyNewCard on the ProfileNFT contract to attach the card to the user's profile

### Requirement 7: Signature-Based Card Claiming

**User Story:** As an authenticated user with a profile, I want to claim a ReputationCard using a signature provided by an issuer, so that I can receive credentials that have been pre-approved for me.

#### Acceptance Criteria

1. WHEN a user provides a template ID, nonce, token URI, and Claim_Signature, THE TrustFi_System SHALL verify that the caller address matches the user address in the signature
2. WHEN the user verification succeeds, THE TrustFi_System SHALL reconstruct the EIP712 typed data hash using the provided parameters
3. WHEN the typed data hash is reconstructed, THE TrustFi_System SHALL recover the signer address from the Claim_Signature
4. WHEN the signer address is recovered, THE TrustFi_System SHALL verify that the signer matches the template issuer address
5. WHEN the signature is valid, THE TrustFi_System SHALL verify that the nonce has not been used previously for this template and profile combination
6. WHEN all verifications pass, THE TrustFi_System SHALL mint a new ReputationCard and attach it to the user's ProfileNFT

### Requirement 8: Template Creation by Admin

**User Story:** As an admin, I want to create new ReputationCard templates, so that issuers can issue cards based on predefined configurations.

#### Acceptance Criteria

1. WHEN an admin provides template parameters including template ID, issuer address, max supply, tier, start time, and end time, THE TrustFi_System SHALL verify that the caller has TEMPLATE_MANAGER_ROLE
2. WHEN the role verification succeeds, THE TrustFi_System SHALL verify that the template ID does not already exist by checking that the issuer address in the templates mapping is zero
3. WHEN the template ID is unique, THE TrustFi_System SHALL verify that the tier value is between 1 and 3 and has a corresponding score in the tierToScore mapping
4. WHEN the tier is valid, THE TrustFi_System SHALL verify that if endTime is greater than zero, then startTime is less than endTime
5. WHEN all validations pass, THE TrustFi_System SHALL create a new Template record with the provided parameters and emit a TemplateCreated event

### Requirement 9: Template Pause Management

**User Story:** As an admin or issuer, I want to pause or unpause a ReputationCard template, so that I can temporarily disable card issuance without deleting the template.

#### Acceptance Criteria

1. WHEN an admin or issuer calls setTemplatePaused with a template ID and pause state, THE TrustFi_System SHALL verify that the template exists by checking that the issuer address is not zero
2. WHEN the template exists, THE TrustFi_System SHALL verify that the caller is either the template issuer or has TEMPLATE_MANAGER_ROLE
3. WHEN the authorization check passes, THE TrustFi_System SHALL update the isPaused property of the Template to the provided state
4. WHEN the isPaused property is updated, THE TrustFi_System SHALL emit a TemplatePaused event
5. WHILE a template isPaused property is true, THE TrustFi_System SHALL reject all attempts to issue or claim cards from that template

### Requirement 10: Admin Dashboard and Issuer Management

**User Story:** As an admin, I want to view platform analytics and manage issuer permissions, so that I can monitor system health and control who can issue ReputationCards.

#### Acceptance Criteria

1. WHEN an admin navigates to the admin dashboard, THE TrustFi_System SHALL verify that the connected wallet has DEFAULT_ADMIN_ROLE
2. WHEN the role verification succeeds, THE TrustFi_System SHALL display total counts of profiles, templates, and issued cards
3. WHEN an admin navigates to the issuer management page, THE TrustFi_System SHALL display a list of all addresses with TEMPLATE_MANAGER_ROLE
4. WHEN an admin provides an address and clicks grant issuer role, THE TrustFi_System SHALL call grantRole with TEMPLATE_MANAGER_ROLE for that address
5. WHEN an admin selects an issuer and clicks revoke role, THE TrustFi_System SHALL call revokeRole with TEMPLATE_MANAGER_ROLE for that address

### Requirement 11: Issuer Portal - Template Management Interface

**User Story:** As an issuer, I want to view and manage my ReputationCard templates through a dedicated interface, so that I can efficiently create and configure the credentials I offer.

#### Acceptance Criteria

1. WHEN an issuer navigates to the issuer portal, THE TrustFi_System SHALL verify that the connected wallet has TEMPLATE_MANAGER_ROLE
2. WHEN the role verification succeeds, THE TrustFi_System SHALL display all templates where the issuer address matches the connected wallet
3. WHEN an issuer views their templates list, THE TrustFi_System SHALL display for each template the template ID, tier, current supply, max supply, and pause state
4. WHEN an issuer clicks on a template, THE TrustFi_System SHALL display detailed template information including start time, end time, and total claims
5. WHEN an issuer clicks the pause toggle for a template, THE TrustFi_System SHALL call setTemplatePaused with the appropriate state

### Requirement 12: Issuer Portal - Direct Issuance Interface

**User Story:** As an issuer, I want to directly issue ReputationCards to users through a form interface, so that I can reward users without requiring them to claim manually.

#### Acceptance Criteria

1. WHEN an issuer navigates to the issue credential page, THE TrustFi_System SHALL display a form with fields for recipient address, template selection, and token URI
2. WHEN an issuer selects a template from the dropdown, THE TrustFi_System SHALL filter the list to show only templates where the issuer address matches the connected wallet
3. WHEN an issuer provides all required fields and clicks issue, THE TrustFi_System SHALL call issueDirect on the ReputationCard contract
4. WHEN the issueDirect transaction is confirmed, THE TrustFi_System SHALL display a success message with the newly minted card ID
5. IF the issueDirect transaction fails due to validation errors, THEN THE TrustFi_System SHALL display the specific error message to the issuer

### Requirement 13: Claim Link Generation

**User Story:** As an issuer, I want to generate claim links with embedded signatures, so that I can distribute ReputationCards to users through shareable URLs.

#### Acceptance Criteria

1. WHEN an issuer navigates to the claim links page, THE TrustFi_System SHALL display a form with fields for user address, template selection, and nonce
2. WHEN an issuer provides all required fields and clicks generate link, THE TrustFi_System SHALL construct an EIP712 typed data structure with the claim parameters
3. WHEN the typed data is constructed, THE TrustFi_System SHALL prompt the issuer to sign the data using their connected wallet
4. WHEN the signature is generated, THE TrustFi_System SHALL construct a claim URL containing the encoded parameters and signature
5. WHEN the claim URL is generated, THE TrustFi_System SHALL display the URL with a copy-to-clipboard button for easy distribution

### Requirement 14: Public Claim Page

**User Story:** As a user, I want to claim a ReputationCard by visiting a claim link, so that I can easily receive credentials shared by issuers.

#### Acceptance Criteria

1. WHEN a user navigates to a claim URL, THE TrustFi_System SHALL parse the URL parameters to extract the template ID, nonce, token URI, and signature
2. WHEN the parameters are extracted, THE TrustFi_System SHALL display the template information and a connect wallet button if no wallet is connected
3. WHEN a user connects their wallet, THE TrustFi_System SHALL verify that the connected address has a ProfileNFT
4. WHEN the ProfileNFT is verified, THE TrustFi_System SHALL display a claim button
5. WHEN the user clicks the claim button, THE TrustFi_System SHALL call claimWithSignature on the ReputationCard contract with the parsed parameters

### Requirement 15: Profile Customization

**User Story:** As an authenticated user with a profile, I want to customize my profile with an avatar, banner, display name, bio, and social links, so that I can personalize my identity and make it more recognizable to others.

#### Acceptance Criteria

1. WHEN a user navigates to the profile settings page, THE TrustFi_System SHALL display a form with fields for display name, bio, avatar, banner, Twitter handle, Discord handle, and website URL
2. WHEN a user uploads an avatar image file, THE TrustFi_System SHALL validate that the file is an image format and does not exceed 5MB in size
3. WHEN the avatar validation passes, THE TrustFi_System SHALL upload the file to Pinata IPFS and retrieve the IPFS URL
4. WHEN a user uploads a banner image file, THE TrustFi_System SHALL validate that the file is an image format and does not exceed 10MB in size
5. WHEN the banner validation passes, THE TrustFi_System SHALL upload the file to Pinata IPFS and retrieve the IPFS URL
6. WHEN a user submits the profile customization form, THE TrustFi_System SHALL update the corresponding record in the Supabase_Database profiles table
7. WHEN the profile update is successful, THE TrustFi_System SHALL display the updated profile information on the profile view page
8. WHEN a user views another user's profile, THE TrustFi_System SHALL display the avatar, banner, display name, bio, and social links if they have been set

### Requirement 16: Error Handling and User Feedback

**User Story:** As a user or admin, I want to receive clear error messages when operations fail, so that I can understand what went wrong and how to resolve the issue.

#### Acceptance Criteria

1. WHEN any smart contract transaction fails, THE TrustFi_System SHALL capture the error message from the blockchain
2. WHEN an error message is captured, THE TrustFi_System SHALL parse the message to extract human-readable information
3. WHEN the error information is extracted, THE TrustFi_System SHALL display the error in a user-friendly format with suggested actions
4. WHEN a user attempts an action without proper permissions, THE TrustFi_System SHALL display an error message indicating the required role or permission
5. WHEN a network error occurs during a transaction, THE TrustFi_System SHALL display a message indicating the network issue and suggest retrying the operation
